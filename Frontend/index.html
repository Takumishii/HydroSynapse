<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydroponic OS | Terminal Híbrido</title>
    <!-- Carga de Three.js y Chart.js para la simulación y gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Carga de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900 text-neon-green">

    <!-- BARRA DE COMANDOS (Inspector Panel) -->
    <div id="moduleInspector" class="flex items-center overflow-x-auto">
        <span class="mr-4 text-white font-bold text-lg whitespace-nowrap">HYDROPONIC OS</span>
        <!-- Items de módulo inyectados por JS -->
    </div>

    <!-- ESCRITORIO / CONTENEDOR PRINCIPAL -->
    <div id="desktopContainer">

        <!-- MÓDULO 1: CÁLCULO DE RECETA -->
        <div id="module-calc" class="module-window w-96 h-auto" style="top: 50px; left: 750px; z-index: 51;">
            <div class="window-header">
                <span>[ CALCULO DE RECETA ]</span>
                <span class="close-btn" onclick="toggleModule('module-calc', true)">[X]</span>
            </div>
            <div class="p-3 space-y-3">
                <label class="block">Volumen del Tanque (L):</label>
                <input type="number" id="volumenTanque" value="100" class="w-full">
                
                <label class="block">Perfil de Nutrientes:</label>
                <select id="perfilPlanta" class="w-full"></select>
                
                <button onclick="calcularDosis()" class="w-full mt-4 p-2 bg-neon-blue text-black font-bold">CALCULAR DOSIS</button>
            </div>
        </div>
        
        <!-- MÓDULO 2: DATOS DE DOSIFICACIÓN -->
        <div id="module-results" class="module-window w-80 h-auto" style="top: 250px; left: 750px; display: none;">
            <div class="window-header">
                <span>[ DATOS DE DOSIFICACIÓN ]</span>
                <span class="close-btn" onclick="toggleModule('module-results', true)">[X]</span>
            </div>
            <div class="p-3">
                <div class="mb-3 border-b border-neon-green/50 pb-1">
                    <p>EC Estimada: <span id="val-ec" class="font-bold text-neon-blue">0.00 mS/cm</span></p>
                    <p>pH Estimado: <span id="val-ph" class="font-bold text-neon-blue">0.00</span></p>
                </div>
                <h4 class="text-neon-pink mb-2">DOSIS REQUERIDAS (g):</h4>
                <table class="w-full text-xs">
                    <thead>
                        <tr class="border-b-2 border-neon-green">
                            <th class="text-left">Sal</th>
                            <th class="text-right">Gramos</th>
                        </tr>
                    </thead>
                    <tbody id="tablaDosisBody">
                        <!-- Filas inyectadas por JS -->
                    </tbody>
                </table>
                <button onclick="enviarAProcesador()" class="w-full mt-4 p-2 bg-neon-green text-black font-bold">ENVIAR A DOSIFICADOR</button>
            </div>
        </div>

        <!-- MÓDULO 3: ANALIZADOR QUÍMICO -->
        <div id="module-analyze" class="module-window w-80 h-auto" style="top: 450px; left: 750px; display: none;">
            <div class="window-header">
                <span>[ ANALIZADOR QUÍMICO ]</span>
                <span class="close-btn" onclick="toggleModule('module-analyze', true)">[X]</span>
            </div>
            <div class="p-3 space-y-3">
                <h4 class="text-neon-pink">Muestra y Concentración:</h4>
                <input type="text" id="chemFormula" placeholder="Fórmula (e.g., KCL)" class="w-2/3">
                <input type="number" id="chemPpm" placeholder="PPM" class="w-1/3">
                <button onclick="agregarSal()" class="w-full">AGREGAR SAL</button>
                <ul id="listaSales" class="border p-2 min-h-[30px] max-h-[100px] overflow-y-auto border-neon-green/50">
                    <!-- Lista de sales agregadas -->
                </ul>
                <button onclick="analizarAgua()" class="w-full mt-2 p-2 bg-neon-blue text-black font-bold">ANALIZAR MUESTRA</button>
            </div>
        </div>

        <!-- MÓDULO 4: BALANCE NPK -->
        <div id="module-npk-balance" class="module-window w-96 h-80" style="top: 50px; left: 1100px; display: none;">
            <div class="window-header">
                <span>[ BALANCE NPK ]</span>
                <span class="close-btn" onclick="toggleModule('module-npk-balance', true)">[X]</span>
            </div>
            <div class="p-3 h-[calc(100%-40px)]">
                 <canvas id="npkChart" class="h-full w-full"></canvas>
            </div>
        </div>
        
        <!-- MÓDULO 5: INVENTARIO DE SALES -->
        <div id="module-inventory" class="module-window w-[450px] h-96" style="top: 50px; left: 100px; z-index: 52;">
            <div class="window-header">
                <span>[ INVENTARIO DE SALES ]</span>
                <span class="close-btn" onclick="toggleModule('module-inventory', true)">[X]</span>
            </div>
            <div class="p-3 space-y-4">
                <h4 class="text-neon-pink border-b border-neon-pink/50 pb-1">Stock Actual (Kg)</h4>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2 border-neon-blue">
                            <th class="text-left">Sal</th>
                            <th class="text-right">Stock (Kg)</th>
                            <th class="text-right">Costo ($/Kg)</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        <!-- Filas inyectadas por JS/Firestore -->
                    </tbody>
                </table>
                <p class="text-xs text-neon-blue">Stock bajo (LOW): &lt; 5.0 Kg</p>
                <button class="w-full p-2 bg-neon-blue text-black font-bold">GENERAR ORDEN DE COMPRA</button>
            </div>
        </div>

        <!-- MÓDULO 6: DIAGNÓSTICO DE DEFICIENCIAS -->
        <div id="module-diagnosis" class="module-window w-80 h-72" style="top: 400px; left: 100px; z-index: 53;">
            <div class="window-header">
                <span>[ DIAGNÓSTICO DE DEFICIENCIAS ]</span>
                <span class="close-btn" onclick="toggleModule('module-diagnosis', true)">[X]</span>
            </div>
            <div class="p-3 space-y-3">
                <h4 class="text-neon-pink border-b border-neon-pink/50 pb-1">Síntomas Visuales</h4>
                <label class="block">Seleccione el síntoma principal:</label>
                <select id="symptomSelector" class="w-full">
                    <option value="clorosis_hojas_viejas">Clorosis (amarilleamiento) en hojas viejas</option>
                    <option value="necrosis_bordes">Necrosis o quemadura en bordes de hojas nuevas</option>
                    <option value="hojas_curvadas">Hojas nuevas pequeñas o curvadas</option>
                    <option value="tallos_púrpura">Tallos o envés de hojas púrpuras</option>
                </select>
                <button onclick="runDiagnosis()" class="w-full p-2 bg-neon-green text-black font-bold">ANALIZAR SÍNTOMAS</button>
                <div id="diagnosisResult" class="text-sm mt-2 border p-2 border-neon-pink/50 min-h-[50px]">
                    <!-- Resultado inyectado aquí -->
                </div>
            </div>
        </div>
        
        <!-- MÓDULO 7: HISTORIAL DE DOSIFICACIÓN (NUEVO) -->
        <div id="module-history" class="module-window w-[600px] h-96" style="top: 150px; left: 20px; display: none;">
            <div class="window-header">
                <span>[ HISTORIAL DE DOSIFICACIÓN ]</span>
                <span class="close-btn" onclick="toggleModule('module-history', true)">[X]</span>
            </div>
            <div class="p-3">
                <p class="text-neon-pink border-b border-neon-pink/50 pb-1 mb-2">Registros de Nutrición Aplicada</p>
                <div class="overflow-y-auto h-[calc(100vh-270px)]">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b-2 border-neon-blue text-left">
                                <th class="p-1">Fecha/Hora</th>
                                <th class="p-1">Perfil</th>
                                <th class="p-1">Vol. (L)</th>
                                <th class="p-1">EC Final</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <!-- Filas inyectadas por JS/Firestore -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- MÓDULO 8: PERFILES DE NUTRIENTES EDITABLES (NUEVO) -->
        <div id="module-profiles" class="module-window w-[350px] h-auto" style="top: 50px; left: 400px; display: none;">
            <div class="window-header">
                <span>[ PERFILES DE NUTRIENTES ]</span>
                <span class="close-btn" onclick="toggleModule('module-profiles', true)">[X]</span>
            </div>
            <div class="p-3 space-y-3">
                <h4 class="text-neon-pink border-b border-neon-pink/50 pb-1">Crear/Editar Receta</h4>
                <input type="text" id="profileName" placeholder="Nombre del Perfil" class="w-full">
                <div class="grid grid-cols-4 gap-2">
                    <input type="number" id="profileN" placeholder="N (ppm)" value="150">
                    <input type="number" id="profileP" placeholder="P (ppm)" value="50">
                    <input type="number" id="profileK" placeholder="K (ppm)" value="200">
                    <input type="number" id="profileEC" placeholder="EC (mS)" value="1.8">
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <input type="number" id="profilepH" placeholder="pH" value="5.8">
                     <button onclick="saveNutrientProfile()" class="w-full bg-neon-green text-black font-bold">GUARDAR PERFIL</button>
                </div>

                <h4 class="text-neon-blue border-b border-neon-blue/50 pb-1 mt-4">Perfiles Guardados</h4>
                <ul id="profilesList" class="max-h-40 overflow-y-auto space-y-1">
                    <!-- Lista de perfiles inyectada por JS/Firestore -->
                </ul>
            </div>
        </div>

        <!-- MÓDULO FIJO A: VISUALIZACIÓN 3D -->
        <div id="module-sim" class="flex flex-col items-center justify-center p-2">
            <!-- El canvas 3D se inyecta aquí -->
            <div id="simContent" class="w-full h-full"></div>
        </div>

        <!-- MÓDULO FIJO B: CONSOLA DE REGISTROS -->
        <div id="module-console">
            <div class="p-1 border-b border-neon-pink/50 bg-black/50">CONSOLA DE REGISTROS</div>
            <div id="consoleLog"></div>
        </div>
        
        <!-- BARRA DE ESTADO INFERIOR -->
        <div id="statusBar" class="text-sm text-neon-green z-200">
            <span id="statusText">STATUS: Inicializando...</span>
        </div>

    </div>

    <!-- Carga el script de inicialización y lógica -->
    <script type="module" src="renderer.js"></script>
</body>
</html>